#+STARTUP: indent

* swarm nodeにラベルを追加

replica setの各ノードがどのmanagerで実行されるのかをdocker-composeにて指定するので
ラベルを設定

- docker01
#+begin_src sh
$ sudo docker node update --label-add mongo.replica.rs1=1 docker1
$ sudo docker node update --label-add mongo.replica.rs2=1 docker1
$ sudo docker node update --label-add mongo.mongos=1 docker1
#+end_src

- docker02
#+begin_src sh
$ sudo docker node update --label-add mongo.replica.rs1=2 docker2
$ sudo docker node update --label-add mongo.replica.rs2=2 docker2
$ sudo docker node update --label-add mongo.mongos=2 docker2
#+end_src

- docker03
#+begin_src sh
$ sudo docker node update --label-add mongo.replica.rs1=3 docker3
$ sudo docker node update --label-add mongo.replica.rs2=3 docker3
#+end_src

* stack deploy

#+begin_src sh
$ sudo docker stack deploy mongo --compose-file docker-compose.yml
$ sudo docker stack ls
$ sudo docker service ls
#+end_src

- クラスタを最構築する際、docker volume pruneを忘れずに

* レプリカ初期設定

- docker01
#+begin_src sh
$ sudo docker exec -it $(docker ps -qf label=com.docker.swarm.service.name=mongo_mongocfg_rs1_1) mongo --port 27017 /rs_inits/rs1-init.js
$ sudo docker exec -it $(docker ps -qf label=com.docker.swarm.service.name=mongo_mongosrd_rs2_1) mongo --port 27017 /rs_inits/rs2-init.js
$ sudo docker exec -it $(docker ps -qf label=com.docker.swarm.service.name=mongo_mongos_1) mongo --port 27017 /rs_inits/mongos01-init.js
#+end_src

- docker02
#+begin_src sh
$ sudo docker exec -it $(docker ps -qf label=com.docker.swarm.service.name=mongos_mongos_2) mongo --port 27017 /rs_inits/mongos02-init.js
#+end_src
